<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëª¨ìŠ¤ ë¶€í˜¸ ë§ˆìŠ¤í„° (Final)</title>
    <style>
        :root {
            --bg-color: #2c3e50;
            --text-color: #ecf0f1;
            --accent-color: #e74c3c;
            --secondary-color: #34495e;
            --active-color: #f1c40f;
            --keyboard-bg: #455a64;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            text-align: center;
            user-select: none;
            -webkit-user-select: none; 
            touch-action: manipulation;
            overflow: hidden;
        }

        .container {
            width: 95%;
            max-width: 500px;
            background: var(--secondary-color);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 95vh;
            overflow-y: auto;
        }

        h1, h2 { margin: 0 0 10px 0; font-size: 1.5rem; }
        .hidden { display: none !important; }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        button:active { transform: scale(0.96); }
        button.secondary { background-color: #7f8c8d; }
        button.action-btn { width: 100%; margin-top: 5px; }

        #telegraph-key {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            font-size: 1.2rem;
            margin: 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f39c12;
            box-shadow: 0 6px #d35400;
            touch-action: none; 
        }

        #telegraph-key:active, #telegraph-key.active {
            transform: translateY(4px);
            box-shadow: 0 2px #d35400;
            background: #e67e22;
        }

        .display-box {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 5px;
            font-size: 2.2rem;
            font-weight: bold;
            letter-spacing: 3px;
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feedback {
            font-size: 1rem;
            height: 1.2rem;
            color: var(--active-color);
            margin: 5px 0;
        }

        #keyboard-area {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            margin-top: 10px;
            padding: 5px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }

        .key-btn {
            background-color: var(--keyboard-bg);
            color: white;
            padding: 12px 0;
            font-size: 1.1rem;
            border-radius: 5px;
            border: none;
            box-shadow: 0 2px rgba(0,0,0,0.2);
        }
        .key-btn:active {
            background-color: #607d8b;
            transform: translateY(2px);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            text-align: left;
        }
        input[type=range] { width: 60%; }
    </style>
</head>
<body>

<div class="container">
    <div id="menu-screen">
        <h1>ğŸ“¡ ëª¨ìŠ¤ ë§ˆìŠ¤í„°</h1>
        <p style="font-size:0.9rem; opacity:0.8;">í„°ì¹˜í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”</p>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="app.navigate('listening')">ğŸ§ ë“£ê¸° ì—°ìŠµ (ìˆ˜ì‹ )</button>
            <button onclick="app.navigate('sending')">ğŸ”¨ ë³´ë‚´ê¸° ì—°ìŠµ (ì†¡ì‹ )</button>
            <button class="secondary" onclick="app.navigate('settings')">âš™ï¸ ì„¤ì •</button>
        </div>
    </div>

    <div id="listening-screen" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>ë“£ê¸° ì—°ìŠµ</h2>
            <button class="secondary" style="padding:5px 10px; font-size:0.8rem;" onclick="app.navigate('menu')">ì¢…ë£Œ</button>
        </div>
        
        <div class="display-box" id="listening-display" style="font-size: 3rem;">?</div>
        
        <div style="display:flex; gap:5px;">
            <button class="action-btn" onclick="app.playCurrentChallenge()">ğŸ”Š ë‹¤ì‹œ ë“£ê¸°</button>
            <button class="action-btn secondary" onclick="app.giveUpAndNext()">ğŸ³ï¸ ì •ë‹µ ë³´ê¸°</button>
        </div>

        <p class="feedback" id="listening-feedback"></p>
        
        <div id="keyboard-area">
            </div>
    </div>

    <div id="sending-screen" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>ë³´ë‚´ê¸° ì—°ìŠµ</h2>
            <button class="secondary" style="padding:5px 10px; font-size:0.8rem;" onclick="app.navigate('menu')">ì¢…ë£Œ</button>
        </div>
        <p style="margin:5px;">ì•„ë˜ ê¸€ìë¥¼ ì‹ í˜¸ë¡œ ë³´ë‚´ì„¸ìš”</p>
        <div style="font-size:3rem; font-weight:bold; color:var(--active-color);" id="target-char">READY</div>
        
        <div class="display-box" id="sending-result" style="font-size: 2rem;"></div>
        
        <button id="telegraph-key">PUSH</button> 
        <p class="feedback" id="sending-feedback"></p>
    </div>

    <div id="settings-screen" class="hidden">
        <h2>ì„¤ì •</h2>
        <div class="setting-row">
            <label>ì†ë„ (WPM): <span id="wpm-val">20</span></label>
            <input type="range" id="wpm-slider" min="5" max="30" value="20" oninput="app.updateSettings()">
        </div>
        <div class="setting-row">
            <label>ì£¼íŒŒìˆ˜ (Hz): <span id="freq-val">600</span></label>
            <input type="range" id="freq-slider" min="400" max="900" value="600" oninput="app.updateSettings()">
        </div>
        <button class="secondary action-btn" onclick="app.navigate('menu')">ì €ì¥ í›„ ëŒì•„ê°€ê¸°</button>
    </div>
</div>

<script>
const MORSE_CODE = {
    'A': 'â€¢â€“', 'B': 'â€“â€¢â€¢â€¢', 'C': 'â€“â€¢â€“â€¢', 'D': 'â€“â€¢â€¢', 'E': 'â€¢', 'F': 'â€¢â€¢â€“â€¢',
    'G': 'â€“â€“â€¢', 'H': 'â€¢â€¢â€¢â€¢', 'I': 'â€¢â€¢', 'J': 'â€¢â€“â€“â€“', 'K': 'â€“â€¢â€“', 'L': 'â€¢â€“â€¢â€¢',
    'M': 'â€“â€“', 'N': 'â€“â€¢', 'O': 'â€“â€“â€“', 'P': 'â€¢â€“â€“â€¢', 'Q': 'â€“â€“â€¢â€“', 'R': 'â€¢â€“â€¢',
    'S': 'â€¢â€¢â€¢', 'T': 'â€“', 'U': 'â€¢â€¢â€“', 'V': 'â€¢â€¢â€¢â€“', 'W': 'â€¢â€“â€“', 'X': 'â€“â€¢â€¢â€“',
    'Y': 'â€“â€¢â€“â€“', 'Z': 'â€“â€“â€¢â€¢',
    '1': 'â€¢â€“â€“â€“â€“', '2': 'â€¢â€¢â€“â€“â€“', '3': 'â€¢â€¢â€¢â€“â€“', '4': 'â€¢â€¢â€¢â€¢â€“', '5': 'â€¢â€¢â€¢â€¢â€¢',
    '6': 'â€“â€¢â€¢â€¢â€¢', '7': 'â€“â€“â€¢â€¢â€¢', '8': 'â€“â€“â€“â€¢â€¢', '9': 'â€“â€“â€“â€“â€¢', '0': 'â€“â€“â€“â€“â€“'
};

const app = {
    audioCtx: null,
    oscillator: null,
    gainNode: null,
    
    wpm: 20,
    frequency: 600,
    dotDuration: 60, 

    currentChallengeChar: null, 
    sendingTargetChar: null,    
    inputSequence: "",          
    keyPressStartTime: 0,
    inputTimer: null,
    
    // [3ë²ˆ ìš”êµ¬ì‚¬í•­] ì¶œì œ íšŸìˆ˜ ê¸°ë¡ìš© ê°ì²´
    charCounts: {},

    init: function() {
        // charCounts ì´ˆê¸°í™”
        for(let char in MORSE_CODE) {
            this.charCounts[char] = 0;
        }

        this.updateSettings();
        this.renderKeyboard(); 
        this.setupEventListeners();
    },

    renderKeyboard: function() {
        const keyboardArea = document.getElementById('keyboard-area');
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".split("");
        
        chars.forEach(char => {
            const btn = document.createElement('button');
            btn.innerText = char;
            btn.className = 'key-btn';
            btn.onclick = () => this.checkListeningAnswer(char);
            keyboardArea.appendChild(btn);
        });
    },

    initAudio: function() {
        try {
            if (!this.audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.audioCtx = new AudioContext();
            }
            if (this.audioCtx.state === 'suspended') {
                this.audioCtx.resume();
            }
        } catch (e) {
            console.error(e);
        }
    },

    updateSettings: function() {
        const wpmInput = document.getElementById('wpm-slider');
        const freqInput = document.getElementById('freq-slider');
        
        if(wpmInput) this.wpm = parseInt(wpmInput.value);
        if(freqInput) this.frequency = parseInt(freqInput.value);
        
        this.dotDuration = 1200 / this.wpm;

        if(document.getElementById('wpm-val')) document.getElementById('wpm-val').innerText = this.wpm;
        if(document.getElementById('freq-val')) document.getElementById('freq-val').innerText = this.frequency;
    },

    startTone: function() {
        this.initAudio();
        if (this.oscillator) return; 

        try {
            this.oscillator = this.audioCtx.createOscillator();
            this.gainNode = this.audioCtx.createGain();

            this.oscillator.type = 'sine';
            this.oscillator.frequency.setValueAtTime(this.frequency, this.audioCtx.currentTime);
            
            this.gainNode.gain.setValueAtTime(0, this.audioCtx.currentTime);
            this.gainNode.gain.linearRampToValueAtTime(1, this.audioCtx.currentTime + 0.01);

            this.oscillator.connect(this.gainNode);
            this.gainNode.connect(this.audioCtx.destination);
            this.oscillator.start();
        } catch (e) {}
    },

    stopTone: function() {
        if (this.oscillator) {
            try {
                this.gainNode.gain.linearRampToValueAtTime(0, this.audioCtx.currentTime + 0.01);
                this.oscillator.stop(this.audioCtx.currentTime + 0.01);
            } catch(e) {}
            this.oscillator = null;
        }
    },

    navigate: function(screenId) {
        document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
        const targetScreen = document.getElementById(screenId + '-screen');
        if (targetScreen) targetScreen.classList.remove('hidden');

        this.initAudio();

        if (screenId === 'listening') this.startListeningMode();
        if (screenId === 'sending') this.startSendingMode();
    },

    // [3ë²ˆ ìš”êµ¬ì‚¬í•­ í•µì‹¬] ê°€ì¤‘ì¹˜ ëœë¤ ì„ íƒ í•¨ìˆ˜
    getWeightedRandomChar: function() {
        const chars = Object.keys(MORSE_CODE);
        
        // 1. í˜„ì¬ ê°€ì¥ ë§ì´ ë‚˜ì˜¨ íšŸìˆ˜ ì°¾ê¸°
        let maxCount = 0;
        for (let char of chars) {
            if (this.charCounts[char] > maxCount) maxCount = this.charCounts[char];
        }

        // 2. ê°€ì¤‘ì¹˜ë¥¼ ì ìš©í•œ ì¶”ì²¨ ë°•ìŠ¤ ë§Œë“¤ê¸°
        let weightedList = [];
        for (let char of chars) {
            let weight = 10; // ê¸°ë³¸ ê°€ì¤‘ì¹˜
            
            // ê°€ì¥ ë§ì´ ë‚˜ì˜¨ ë¬¸ìëŠ” ê°€ì¤‘ì¹˜ë¥¼ 5ë¡œ ì¤„ì„ (50% í™•ë¥  ê°ì†Œ)
            if (this.charCounts[char] === maxCount && maxCount > 0) {
                weight = 5;
            }

            // ê°€ì¤‘ì¹˜ë§Œí¼ ë°°ì—´ì— ë¬¸ì ì¶”ê°€
            for(let i=0; i<weight; i++) {
                weightedList.push(char);
            }
        }

        // 3. ëœë¤ ë½‘ê¸°
        const selectedChar = weightedList[Math.floor(Math.random() * weightedList.length)];
        
        // 4. ë½‘íŒ ë¬¸ìì˜ ì¹´ìš´íŠ¸ ì¦ê°€
        this.charCounts[selectedChar]++;
        
        // (ë””ë²„ê¹…ìš©) ì½˜ì†”ì—ì„œ ì¹´ìš´íŠ¸ í™•ì¸ ê°€ëŠ¥
        // console.log("Char Counts:", this.charCounts);

        return selectedChar;
    },

    // --- ë“£ê¸° ëª¨ë“œ ---
    startListeningMode: function() {
        this.pickRandomChar();
        document.getElementById('listening-feedback').innerText = "";
    },

    pickRandomChar: function() {
        // ê¸°ì¡´ ë‹¨ìˆœ Random ëŒ€ì‹  ê°€ì¤‘ì¹˜ í•¨ìˆ˜ ì‚¬ìš©
        this.currentChallengeChar = this.getWeightedRandomChar();
        document.getElementById('listening-display').innerText = "?";
        setTimeout(() => this.playMorseString(MORSE_CODE[this.currentChallengeChar]), 500);
    },

    playCurrentChallenge: function() {
        if(this.currentChallengeChar) {
            this.playMorseString(MORSE_CODE[this.currentChallengeChar]);
        }
    },

    playMorseString: function(morseStr) {
        if(!this.audioCtx) return;
        
        let now = this.audioCtx.currentTime + 0.1; 

        for (let symbol of morseStr) {
            const duration = (symbol === 'â€¢') ? this.dotDuration : (this.dotDuration * 3);
            
            try {
                const osc = this.audioCtx.createOscillator();
                const gain = this.audioCtx.createGain();
                osc.frequency.value = this.frequency;
                osc.connect(gain);
                gain.connect(this.audioCtx.destination);
                
                osc.start(now);
                osc.stop(now + (duration / 1000));
            } catch (e) {}
            
            now += (duration / 1000) + (this.dotDuration / 1000); 
        }
    },

    checkListeningAnswer: function(inputChar) {
        const feedback = document.getElementById('listening-feedback');
        
        if (inputChar === this.currentChallengeChar) {
            feedback.innerText = "ì •ë‹µ! ğŸ‰";
            feedback.style.color = "#2ecc71";
            document.getElementById('listening-display').innerText = this.currentChallengeChar;
            
            setTimeout(() => {
                feedback.innerText = "";
                this.startListeningMode();
            }, 1000);
        } else {
            feedback.innerText = `ë•¡! (${inputChar}) ë‹¤ì‹œ ë“¤ì–´ë³´ì„¸ìš”.`;
            feedback.style.color = "#e74c3c";
            this.playCurrentChallenge();
        }
    },

    giveUpAndNext: function() {
        const feedback = document.getElementById('listening-feedback');
        feedback.innerText = `ì •ë‹µì€ [ ${this.currentChallengeChar} ] ì…ë‹ˆë‹¤.`;
        feedback.style.color = "#f1c40f";
        document.getElementById('listening-display').innerText = this.currentChallengeChar;
        
        setTimeout(() => {
            this.startListeningMode();
        }, 2000);
    },

    // --- ë³´ë‚´ê¸° ëª¨ë“œ ---
    startSendingMode: function() {
        this.inputSequence = "";
        document.getElementById('sending-result').innerText = "";
        this.pickSendingTarget();
    },

    pickSendingTarget: function() {
        // ì†¡ì‹  ì—°ìŠµë„ ë˜‘ê°™ì´ ê°€ì¤‘ì¹˜ ì ìš©
        this.sendingTargetChar = this.getWeightedRandomChar();
        
        document.getElementById('target-char').innerText = this.sendingTargetChar;
        document.getElementById('sending-feedback').innerText = "ì‹ í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”";
        document.getElementById('target-char').style.color = "var(--active-color)";
        this.inputSequence = "";
        document.getElementById('sending-result').innerText = "";
    },

    handleKeyDown: function() {
        if (this.keyPressStartTime === 0) {
            this.keyPressStartTime = Date.now();
            this.startTone();
            const btn = document.getElementById('telegraph-key');
            if(btn) btn.classList.add('active');
            if(this.inputTimer) clearTimeout(this.inputTimer);
        }
    },

    handleKeyUp: function() {
        if (this.keyPressStartTime !== 0) {
            const duration = Date.now() - this.keyPressStartTime;
            this.stopTone();
            const btn = document.getElementById('telegraph-key');
            if(btn) btn.classList.remove('active');
            this.keyPressStartTime = 0;

            const threshold = this.dotDuration * 2.5; 
            const symbol = (duration < threshold) ? 'â€¢' : 'â€“';
            
            this.inputSequence += symbol;
            document.getElementById('sending-result').innerText = this.inputSequence;

            const checkDelay = this.dotDuration * 7; 
            this.inputTimer = setTimeout(() => this.checkSendingAnswer(), checkDelay);
        }
    },

    checkSendingAnswer: function() {
        const targetCode = MORSE_CODE[this.sendingTargetChar];
        if (this.inputSequence === targetCode) {
            document.getElementById('sending-feedback').innerText = "ì„±ê³µ! â­•";
            document.getElementById('target-char').style.color = "#2ecc71";
            setTimeout(() => {
                this.pickSendingTarget();
            }, 1000);
        } else {
            document.getElementById('sending-feedback').innerText = "ì‹¤íŒ¨ âŒ";
            setTimeout(() => {
                this.inputSequence = "";
                document.getElementById('sending-result').innerText = "";
                document.getElementById('sending-feedback').innerText = "ë‹¤ì‹œ í•´ë³´ì„¸ìš”";
            }, 1000);
        }
    },

    setupEventListeners: function() {
        const keyBtn = document.getElementById('telegraph-key');
        if(keyBtn) {
            keyBtn.addEventListener('touchstart', (e) => {
                e.preventDefault(); 
                this.handleKeyDown();
            }, { passive: false });

            keyBtn.addEventListener('touchend', (e) => {
                e.preventDefault(); 
                this.handleKeyUp();
            });

            keyBtn.addEventListener('mousedown', (e) => { this.handleKeyDown(); });
            keyBtn.addEventListener('mouseup', (e) => { this.handleKeyUp(); });
            keyBtn.addEventListener('mouseleave', (e) => { 
                if(this.keyPressStartTime !== 0) this.handleKeyUp(); 
            });
        }
    }
};

window.app = app;
app.init();
</script>
</body>
</html>
