<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëª¨ìŠ¤ ë¶€í˜¸ ë§ˆìŠ¤í„° (Mobile)</title>
    <style>
        :root {
            --bg-color: #2c3e50;
            --text-color: #ecf0f1;
            --accent-color: #e74c3c;
            --secondary-color: #34495e;
            --active-color: #f1c40f;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            text-align: center;
            /* ëª¨ë°”ì¼ ë“œë˜ê·¸/ì„ íƒ ë°©ì§€ */
            user-select: none;
            -webkit-user-select: none; 
            touch-action: manipulation;
        }

        .container {
            width: 90%;
            max-width: 500px;
            background: var(--secondary-color);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        h1, h2 { margin: 0 0 10px 0; }
        .hidden { display: none !important; }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            /* ëª¨ë°”ì¼ í„°ì¹˜ í•˜ì´ë¼ì´íŠ¸ ì œê±° */
            -webkit-tap-highlight-color: transparent;
        }

        button:active { transform: scale(0.96); }
        button.secondary { background-color: #7f8c8d; }
        
        /* ì†¡ì‹  ë²„íŠ¼ (ì „ê±´) ìŠ¤íƒ€ì¼ - ê°€ì¥ ì¤‘ìš” */
        #telegraph-key {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            font-size: 1.5rem;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f39c12;
            box-shadow: 0 6px #d35400;
            border-bottom: none;
            /* í„°ì¹˜ ì‹œ ì¤Œ ë°©ì§€ */
            touch-action: none; 
        }

        #telegraph-key:active, #telegraph-key.active {
            transform: translateY(4px);
            box-shadow: 0 2px #d35400;
            background: #e67e22;
        }

        .display-box {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 5px;
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 3px;
            min-height: 40px;
            word-break: break-all;
        }

        input[type=text] {
            font-size: 1.2rem;
            padding: 10px;
            width: 70%;
            text-align: center;
            text-transform: uppercase;
            border-radius: 5px;
            border: none;
            margin-top: 10px;
        }

        .feedback {
            font-size: 1rem;
            height: 1.2rem;
            color: var(--active-color);
            margin-top: 5px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            text-align: left;
        }
        input[type=range] { width: 60%; }
    </style>
</head>
<body>

<div class="container">
    <div id="menu-screen">
        <h1>ğŸ“¡ ëª¨ìŠ¤ ë§ˆìŠ¤í„°</h1>
        <p style="font-size:0.9rem; opacity:0.8;">í„°ì¹˜í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”</p>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="app.navigate('listening')">ğŸ§ ë“£ê¸° ì—°ìŠµ (ìˆ˜ì‹ )</button>
            <button onclick="app.navigate('sending')">ğŸ”¨ ë³´ë‚´ê¸° ì—°ìŠµ (ì†¡ì‹ )</button>
            <button class="secondary" onclick="app.navigate('settings')">âš™ï¸ ì„¤ì •</button>
        </div>
    </div>

    <div id="listening-screen" class="hidden">
        <h2>ë“£ê¸° ì—°ìŠµ</h2>
        <div class="display-box" id="listening-display" style="font-size: 3rem;">?</div>
        <button onclick="app.playCurrentChallenge()">ğŸ”Š ë‹¤ì‹œ ë“£ê¸°</button>
        <div>
            <input type="text" id="listening-input" placeholder="ì•ŒíŒŒë²³ ì…ë ¥" maxlength="1">
        </div>
        <p class="feedback" id="listening-feedback"></p>
        <button class="secondary" onclick="app.navigate('menu')">ë©”ë‰´ë¡œ</button>
    </div>

    <div id="sending-screen" class="hidden">
        <h2>ë³´ë‚´ê¸° ì—°ìŠµ</h2>
        <p>ì•„ë˜ ê¸€ìë¥¼ ì‹ í˜¸ë¡œ ë³´ë‚´ì„¸ìš”</p>
        <div style="font-size:2.5rem; font-weight:bold; color:var(--active-color);" id="target-char">READY</div>
        <div class="display-box" id="sending-result" style="font-size: 1.5rem; height:30px; margin-top:10px;"></div>
        
        <button id="telegraph-key">PUSH</button> 
        
        <p class="feedback" id="sending-feedback"></p>
        <button class="secondary" onclick="app.navigate('menu')">ì¢…ë£Œ</button>
    </div>

    <div id="settings-screen" class="hidden">
        <h2>ì„¤ì •</h2>
        <div class="setting-row">
            <label>ì†ë„ (WPM): <span id="wpm-val">20</span></label>
            <input type="range" id="wpm-slider" min="5" max="30" value="20" oninput="app.updateSettings()">
        </div>
        <div class="setting-row">
            <label>ì£¼íŒŒìˆ˜ (Hz): <span id="freq-val">600</span></label>
            <input type="range" id="freq-slider" min="400" max="900" value="600" oninput="app.updateSettings()">
        </div>
        <button class="secondary" onclick="app.navigate('menu')">ì €ì¥ í›„ ëŒì•„ê°€ê¸°</button>
    </div>
</div>

<script>
/**
 * ëª¨ë°”ì¼ í˜¸í™˜ì„± ê°•í™” ìˆ˜ì • ë²„ì „
 */
const MORSE_CODE = {
    'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.',
    'G': '--.', 'H': '....', 'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..',
    'M': '--', 'N': '-.', 'O': '---', 'P': '.--.', 'Q': '--.-', 'R': '.-.',
    'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
    'Y': '-.--', 'Z': '--..',
    '1': '.----', '2': '..---', '3': '...--', '4': '....-', '5': '.....',
    '6': '-....', '7': '--...', '8': '---..', '9': '----.', '0': '-----'
};

const app = {
    audioCtx: null,
    oscillator: null,
    gainNode: null,
    
    wpm: 20,
    frequency: 600,
    dotDuration: 60, 

    currentChallengeChar: null, 
    sendingTargetChar: null,    
    inputSequence: "",          
    lastInputTime: 0,
    keyPressStartTime: 0,
    inputTimer: null,           

    init: function() {
        this.updateSettings();
        this.setupEventListeners();
    },

    // [ì¤‘ìš”] ì˜¤ë””ì˜¤ ì´ˆê¸°í™” ë¡œì§ ìˆ˜ì • (ì—ëŸ¬ ë°©ì§€)
    initAudio: function() {
        try {
            if (!this.audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.audioCtx = new AudioContext();
            }
            if (this.audioCtx.state === 'suspended') {
                this.audioCtx.resume();
            }
        } catch (e) {
            console.error("ì˜¤ë””ì˜¤ ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
        }
    },

    updateSettings: function() {
        const wpmInput = document.getElementById('wpm-slider');
        const freqInput = document.getElementById('freq-slider');
        
        if(wpmInput) this.wpm = parseInt(wpmInput.value);
        if(freqInput) this.frequency = parseInt(freqInput.value);
        
        this.dotDuration = 1200 / this.wpm;

        if(document.getElementById('wpm-val')) document.getElementById('wpm-val').innerText = this.wpm;
        if(document.getElementById('freq-val')) document.getElementById('freq-val').innerText = this.frequency;
    },

    startTone: function() {
        this.initAudio();
        if (this.oscillator) return; 

        try {
            this.oscillator = this.audioCtx.createOscillator();
            this.gainNode = this.audioCtx.createGain();

            this.oscillator.type = 'sine';
            this.oscillator.frequency.setValueAtTime(this.frequency, this.audioCtx.currentTime);
            
            this.gainNode.gain.setValueAtTime(0, this.audioCtx.currentTime);
            this.gainNode.gain.linearRampToValueAtTime(1, this.audioCtx.currentTime + 0.01);

            this.oscillator.connect(this.gainNode);
            this.gainNode.connect(this.audioCtx.destination);
            this.oscillator.start();
        } catch (e) {
            console.error(e);
        }
    },

    stopTone: function() {
        if (this.oscillator) {
            try {
                this.gainNode.gain.setValueAtTime(1, this.audioCtx.currentTime);
                this.gainNode.gain.linearRampToValueAtTime(0, this.audioCtx.currentTime + 0.01);
                this.oscillator.stop(this.audioCtx.currentTime + 0.01);
            } catch(e) {}
            this.oscillator = null;
        }
    },

    // [í•µì‹¬ ìˆ˜ì •] í™”ë©´ ì „í™˜ ë¡œì§ ìˆœì„œ ë³€ê²½
    navigate: function(screenId) {
        // 1. í™”ë©´ ì „í™˜ì„ 'ë¨¼ì €' ìˆ˜í–‰ (ì˜¤ë””ì˜¤ê°€ ì‹¤íŒ¨í•´ë„ í™”ë©´ì€ ë„˜ì–´ê°€ê²Œ í•¨)
        document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
        const targetScreen = document.getElementById(screenId + '-screen');
        if (targetScreen) targetScreen.classList.remove('hidden');

        // 2. ê·¸ ë‹¤ìŒ ì˜¤ë””ì˜¤ ì´ˆê¸°í™” ì‹œë„
        this.initAudio();

        // 3. ëª¨ë“œë³„ ê¸°ëŠ¥ ì‹¤í–‰
        if (screenId === 'listening') this.startListeningMode();
        if (screenId === 'sending') this.startSendingMode();
    },

    startListeningMode: function() {
        this.pickRandomChar();
        const input = document.getElementById('listening-input');
        input.value = '';
        document.getElementById('listening-feedback').innerText = '';
        input.focus();
    },

    pickRandomChar: function() {
        const chars = Object.keys(MORSE_CODE);
        this.currentChallengeChar = chars[Math.floor(Math.random() * chars.length)];
        document.getElementById('listening-display').innerText = "?";
        // í™”ë©´ ë¡œë”© ì§í›„ ì†Œë¦¬ê°€ ì”¹íˆëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì•½ê°„ì˜ ë”œë ˆì´
        setTimeout(() => this.playMorseString(MORSE_CODE[this.currentChallengeChar]), 600);
    },

    playCurrentChallenge: function() {
        if(this.currentChallengeChar) {
            this.playMorseString(MORSE_CODE[this.currentChallengeChar]);
        }
    },

    playMorseString: function(morseStr) {
        if(!this.audioCtx) return; // ì˜¤ë””ì˜¤ ì—†ìœ¼ë©´ ì¤‘ë‹¨
        
        let now = this.audioCtx.currentTime;
        now += 0.1; 

        for (let symbol of morseStr) {
            const duration = (symbol === '.') ? this.dotDuration : (this.dotDuration * 3);
            
            try {
                const osc = this.audioCtx.createOscillator();
                const gain = this.audioCtx.createGain();
                osc.frequency.value = this.frequency;
                osc.connect(gain);
                gain.connect(this.audioCtx.destination);
                
                osc.start(now);
                osc.stop(now + (duration / 1000));
            } catch (e) {}
            
            now += (duration / 1000) + (this.dotDuration / 1000); 
        }
    },

    checkListeningAnswer: function(input) {
        if (input.toUpperCase() === this.currentChallengeChar) {
            document.getElementById('listening-feedback').innerText = "ì •ë‹µ! ğŸ‰";
            document.getElementById('listening-display').innerText = this.currentChallengeChar;
            setTimeout(() => this.startListeningMode(), 1500);
        } else {
            document.getElementById('listening-feedback').innerText = "ë‹¤ì‹œ ë“¤ì–´ë³´ì„¸ìš”.";
            this.playCurrentChallenge();
        }
        document.getElementById('listening-input').value = '';
    },

    startSendingMode: function() {
        this.inputSequence = "";
        document.getElementById('sending-result').innerText = "";
        this.pickSendingTarget();
    },

    pickSendingTarget: function() {
        const chars = Object.keys(MORSE_CODE);
        this.sendingTargetChar = chars[Math.floor(Math.random() * chars.length)];
        document.getElementById('target-char').innerText = this.sendingTargetChar;
        document.getElementById('sending-feedback').innerText = "ì‹ í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”";
        this.sendingTargetCharElement = document.getElementById('target-char'); 
        this.sendingTargetCharElement.style.color = "var(--active-color)";
        this.inputSequence = "";
        document.getElementById('sending-result').innerText = "";
    },

    handleKeyDown: function() {
        if (this.keyPressStartTime === 0) {
            this.keyPressStartTime = Date.now();
            this.startTone();
            const btn = document.getElementById('telegraph-key');
            if(btn) btn.classList.add('active');
            if(this.inputTimer) clearTimeout(this.inputTimer);
        }
    },

    handleKeyUp: function() {
        if (this.keyPressStartTime !== 0) {
            const duration = Date.now() - this.keyPressStartTime;
            this.stopTone();
            const btn = document.getElementById('telegraph-key');
            if(btn) btn.classList.remove('active');
            this.keyPressStartTime = 0;

            const threshold = this.dotDuration * 2.5; 
            const symbol = (duration < threshold) ? '.' : '-';
            
            this.inputSequence += symbol;
            document.getElementById('sending-result').innerText = this.inputSequence;

            const checkDelay = this.dotDuration * 7; 
            this.inputTimer = setTimeout(() => this.checkSendingAnswer(), checkDelay);
        }
    },

    checkSendingAnswer: function() {
        const targetCode = MORSE_CODE[this.sendingTargetChar];
        if (this.inputSequence === targetCode) {
            document.getElementById('sending-feedback').innerText = "ì„±ê³µ! â­•";
            document.getElementById('target-char').style.color = "#2ecc71";
            setTimeout(() => {
                this.pickSendingTarget();
            }, 1000);
        } else {
            document.getElementById('sending-feedback').innerText = "ì‹¤íŒ¨ âŒ (ì •ë‹µ: " + targetCode + ")";
            this.inputSequence = "";
            document.getElementById('sending-result').innerText = "";
        }
    },

    setupEventListeners: function() {
        const inputField = document.getElementById('listening-input');
        if(inputField) {
            inputField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.checkListeningAnswer(e.target.value);
            });
        }

        const keyBtn = document.getElementById('telegraph-key');
        if(keyBtn) {
            keyBtn.addEventListener('touchstart', (e) => {
                e.preventDefault(); 
                this.handleKeyDown();
            }, { passive: false });

            keyBtn.addEventListener('touchend', (e) => {
                e.preventDefault(); 
                this.handleKeyUp();
            });

            keyBtn.addEventListener('mousedown', (e) => { this.handleKeyDown(); });
            keyBtn.addEventListener('mouseup', (e) => { this.handleKeyUp(); });
            keyBtn.addEventListener('mouseleave', (e) => { 
                if(this.keyPressStartTime !== 0) this.handleKeyUp(); 
            });
        }
    }
};

// [ì¤‘ìš”] HTMLì—ì„œ onclick="app.navigate()"ë¥¼ ì¸ì‹í•  ìˆ˜ ìˆë„ë¡ ì „ì—­ ê°ì²´ì— í• ë‹¹
window.app = app;

app.init();
</script>

